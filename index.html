<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Календарь циклов (офлайн)</title>
  <meta name="theme-color" content="#ffffff"/>
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="apple-touch-icon" href="icon-192.png">
  <style>
    :root { --fg:#1b1b1b; --muted:#777; --accent:#0a7; --bg:#fff; --pill:#e9fff7; --danger:#c00; --light:#f4f4f4;}
    * { box-sizing: border-box; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    body { margin: 0; color: var(--fg); background: var(--bg); }
    header { position: sticky; top: 0; background: #fff; border-bottom:1px solid #eee; padding: 12px 16px; }
    h1 { margin: 0 0 6px; font-size: 18px; }
    .sub { color: var(--muted); font-size: 13px; }
    main { padding: 12px 16px 100px; max-width: 720px; margin: 0 auto; }
    .card { background:#fff; border:1px solid #eee; border-radius: 12px; padding: 12px; margin: 12px 0; }
    .flex { display:flex; gap:10px; align-items:center; flex-wrap: wrap; }
    label { font-size: 13px; color: var(--muted); display:block; margin-bottom:4px; }
    input[type="date"] { padding:10px; border:1px solid #ddd; border-radius:10px; background:#fff; }
    button { padding:10px 14px; border-radius:10px; border:1px solid #ddd; background:#fff; cursor:pointer; }
    button.primary { background: var(--accent); border-color: var(--accent); color:#fff; }
    button.ghost { background:#fff; }
    button.danger { border-color: #f5caca; color:#a00; background:#fff4f4; }
    .counter { padding: 10px 12px; background: var(--pill); border:1px solid #cfe; border-radius:10px; font-weight:600; }
    .counter .muted { font-weight:400; }
    .row { display:flex; align-items:center; justify-content:space-between; gap:8px; }
    .calendar { user-select:none; }
    .cal-head { display:flex; justify-content:space-between; align-items:center; padding:6px 0 10px; }
    .cal-grid { display:grid; grid-template-columns: repeat(7, 1fr); gap:4px; }
    .dow, .day { text-align:center; font-size:13px; padding:6px 0; }
    .dow { color: var(--muted); }
    .day { border:1px solid #eee; border-radius:8px; min-height:38px; display:flex; align-items:center; justify-content:center; position:relative; }
    .day.muted { color:#bbb; background:#fafafa; }
    .day.start { background:#ffeef0; border-color:#ffd2d6; }
    .day.start::after {
      content:""; position:absolute; inset: -1px; border:2px solid #ff6b7a; border-radius:8px; pointer-events:none;
    }
    .list { font-size:14px; }
    .list .item { padding:8px 0; border-bottom:1px dashed #eee; display:flex; justify-content:space-between; gap:8px; }
    .muted { color: var(--muted); }
    .hint { font-size:12px; color: var(--muted); }
  </style>
</head>
<body>
<header>
  <h1>Календарь месячных</h1>
  <div class="sub">Храним только даты начала. Цикл — от начала к началу.</div>
</header>
<main>
  <section class="card">
    <div class="row">
      <div class="counter" id="counter">—</div>
      <div class="flex">
        <button class="ghost" id="btnToday">К сегодня</button>
        <button class="ghost" id="btnExport">Экспорт</button>
        <button class="ghost" id="btnImport">Импорт</button>
      </div>
    </div>
    <div class="hint" style="margin-top:6px;">
      Введите только <b>первый день</b> месячных. Перекрытия не актуальны: один старт — одна дата.
    </div>
  </section>

  <section class="card">
    <div class="calendar">
      <div class="cal-head">
        <button id="prevMonth">◀</button>
        <div id="monthLabel" style="font-weight:600;"></div>
        <button id="nextMonth">▶</button>
      </div>
      <div class="cal-grid" id="dow"></div>
      <div class="cal-grid" id="days"></div>
    </div>
  </section>

  <section class="card">
    <div class="flex" style="align-items:flex-end;">
      <div>
        <label for="start">Дата начала месячных</label>
        <input type="date" id="start">
      </div>
      <button class="primary" id="save">Сохранить дату</button>
      <button class="danger" id="deleteLast">Удалить последнюю</button>
    </div>
  </section>

  <section class="card">
    <div class="row" style="margin-bottom:6px;">
      <div style="font-weight:600;">Записанные даты</div>
      <button class="ghost" id="clearAll">Очистить всё</button>
    </div>
    <div class="list" id="periodList"></div>
  </section>
</main>

<script>
(function(){
  const $ = (id)=>document.getElementById(id);
  const STORAGE_KEY = 'period-tracker.periods.v1';

  // Данные теперь: [{start:'YYYY-MM-DD'}]
  const state = {
    starts: loadAndMigrate(),
    viewYear: new Date().getFullYear(),
    viewMonth: new Date().getMonth(),
  };

  // ----- Storage & Migration -----
  function loadAndMigrate(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return [];
      const arr = JSON.parse(raw);

      // Форматы, которые поддерживаем:
      // 1) [{start:'...', end:'...'}, ...] — старый
      // 2) [{start:'...'}, ...] — новый
      // 3) ['YYYY-MM-DD', ...] — строковый
      let starts = [];
      if(Array.isArray(arr)){
        for(const it of arr){
          if(typeof it === 'string'){
            if(validISO(it)) starts.push({start:it});
          } else if (it && typeof it === 'object'){
            if(typeof it.start === 'string' && validISO(it.start)) {
              starts.push({start: it.start});
            }
          }
        }
      }
      // Удаляем дубли, сортируем
      const uniq = Array.from(new Set(starts.map(s=>s.start))).map(s=>({start:s}));
      uniq.sort((a,b)=>a.start.localeCompare(b.start));

      // Сохраняем уже в новом формате
      localStorage.setItem(STORAGE_KEY, JSON.stringify(uniq));
      return uniq;
    }catch(e){ return []; }
  }
  function persist(){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state.starts));
  }

  // ----- Utils -----
  const ONE = 86400000;
  function validISO(s){ return /^\d{4}-\d{2}-\d{2}$/.test(s); }
  function iso(d){ const x = new Date(d); x.setHours(0,0,0,0); return x.toISOString().slice(0,10); }
  function fromISO(s){ return new Date(s+'T00:00:00'); }
  function daysDiff(a,b){ return Math.round((a-b)/ONE); }
  function fmtRu(d){ return d.toLocaleDateString('ru-RU', {day:'2-digit', month:'short', year:'numeric'}); }
  function addDays(d,n){ const x=new Date(d); x.setDate(x.getDate()+n); return x; }
  function relToToday(d){
    const today = new Date(); today.setHours(0,0,0,0);
    const dd = new Date(d); dd.setHours(0,0,0,0);
    const k = daysDiff(dd,today);
    if(k===0) return 'сегодня';
    if(k===1) return 'завтра';
    if(k===-1) return 'вчера';
    return k>0 ? `через ${k} дн.` : `${Math.abs(k)} дн. назад`;
  }

  // ----- Domain -----
  function sortStartsAsc(){ state.starts.sort((a,b)=>a.start.localeCompare(b.start)); }
  function computeStats(){
    const arr = state.starts;
    const result = { avgCycle:null, nextPred:null };
    if(arr.length < 2) return result;
    const cycles = [];
    for(let i=0;i<arr.length-1;i++){
      const c = daysDiff(fromISO(arr[i+1].start), fromISO(arr[i].start));
      if(c>0) cycles.push(c);
    }
    if(cycles.length){
      result.avgCycle = Math.round(cycles.reduce((s,x)=>s+x,0)/cycles.length);
      const lastStart = fromISO(arr[arr.length-1].start);
      result.nextPred = addDays(lastStart, result.avgCycle);
    }
    return result;
  }

  // ----- Calendar -----
  function buildCalendar(y, m){
    const first = new Date(y, m, 1);
    const startDay = (first.getDay()+6)%7; // Monday=0
    const daysInMonth = new Date(y, m+1, 0).getDate();
    const prevDays = startDay;
    const total = Math.ceil((prevDays + daysInMonth)/7)*7;

    const monthLabel = first.toLocaleString('ru-RU', { month:'long', year:'numeric' });
    $('monthLabel').textContent = monthLabel[0].toUpperCase()+monthLabel.slice(1);

    const dow = ['Пн','Вт','Ср','Чт','Пт','Сб','Вс'];
    $('dow').innerHTML = '';
    dow.forEach(d=>{
      const div = document.createElement('div');
      div.className = 'dow'; div.textContent = d;
      $('dow').appendChild(div);
    });

    $('days').innerHTML = '';
    for(let i=0;i<total;i++){
      const dayNum = i - prevDays + 1;
      let dt, muted = false;
      if(dayNum < 1){ dt = new Date(y, m, 0 + dayNum); muted = true; }
      else if(dayNum > daysInMonth){ dt = new Date(y, m, dayNum); muted = true; }
      else { dt = new Date(y, m, dayNum); }
      dt.setHours(0,0,0,0);
      const isoStr = iso(dt);

      const div = document.createElement('div');
      div.className = 'day'+(muted?' muted':'');
      div.textContent = dt.getDate();

      // mark starts
      const isStart = state.starts.some(s => s.start === isoStr);
      if(isStart) div.classList.add('start');

      $('days').appendChild(div);
    }
  }

  // ----- Rendering -----
  function renderCounter(){
    const s = computeStats();
    let rows = [];
    rows.push(`<div>Средняя длина цикла: ${s.avgCycle ? s.avgCycle+' дн.' : '—'}</div>`);
    if(s.nextPred){
      rows.push(`<div>Ожидаемое начало: ${fmtRu(s.nextPred)} <span class="muted">(${relToToday(s.nextPred)})</span></div>`);
    }
    $('counter').innerHTML = rows.join('');
  }

  function renderList(){
    const box = $('periodList');
    box.innerHTML = '';
    if(state.starts.length===0){
      box.innerHTML = '<div class="muted">Пока пусто.</div>';
      return;
    }
    // newest on top
    for(let i=state.starts.length-1;i>=0;i--){
      const s = state.starts[i].start;
      let cycleTxt = '—';
      if(i < state.starts.length-1){
        const nextStart = state.starts[i+1].start;
        const c = daysDiff(fromISO(nextStart), fromISO(s));
        if(c>0) cycleTxt = `${c} дн.`;
      }
      const el = document.createElement('div');
      el.className = 'item';
      el.innerHTML = `
        <div>
          <strong>${fmtRu(fromISO(s))}</strong>
          <span class="muted">(цикл: ${cycleTxt})</span>
        </div>
        <div class="flex">
          <button class="ghost" data-idx="${i}" data-act="del">Удалить</button>
        </div>
      `;
      box.appendChild(el);
    }
    box.querySelectorAll('button[data-act="del"]').forEach(btn=>{
      btn.addEventListener('click', (e)=>{
        const idx = Number(e.currentTarget.dataset.idx);
        state.starts.splice(idx,1);
        persist(); renderAll();
      });
    });
  }

  function renderCalendar(){ buildCalendar(state.viewYear, state.viewMonth); }
  function renderAll(){ sortStartsAsc(); renderCounter(); renderCalendar(); renderList(); }

  // ----- Actions -----
  $('save').addEventListener('click', ()=>{
    const s = $('start').value;
    if(!s){ alert('Укажи дату начала.'); return; }
    if(!validISO(s)){ alert('Неверный формат даты.'); return; }
    if(state.starts.some(x=>x.start===s)){ alert('Такая дата уже есть.'); return; }
    state.starts.push({start:s});
    persist(); renderAll();
    $('start').value = '';
  });

  $('deleteLast').addEventListener('click', ()=>{
    if(!state.starts.length) return;
    state.starts.pop();
    persist(); renderAll();
  });

  $('clearAll').addEventListener('click', ()=>{
    if(confirm('Удалить все даты?')){ state.starts = []; persist(); renderAll(); }
  });

  $('btnToday').addEventListener('click', ()=>{
    const t = new Date();
    state.viewYear = t.getFullYear();
    state.viewMonth = t.getMonth();
    renderCalendar();
  });

  $('prevMonth').addEventListener('click', ()=>{
    let m = state.viewMonth - 1, y = state.viewYear;
    if(m < 0){ m = 11; y--; }
    state.viewMonth = m; state.viewYear = y;
    renderCalendar();
  });
  $('nextMonth').addEventListener('click', ()=>{
    let m = state.viewMonth + 1, y = state.viewYear;
    if(m > 11){ m = 0; y++; }
    state.viewMonth = m; state.viewYear = y;
    renderCalendar();
  });

  // Export / Import (понимает старые и новые форматы)
  $('btnExport').addEventListener('click', ()=>{
    const data = JSON.stringify(state.starts, null, 2); // [{start:"..."}]
    const blob = new Blob([data], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'cycle-starts-export.json';
    document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);
  });
  $('btnImport').addEventListener('click', async ()=>{
    try{
      const [file] = await new Promise((res)=>{
        const inp = document.createElement('input');
        inp.type = 'file'; inp.accept = 'application/json';
        inp.addEventListener('change', ()=>res(inp.files||[]), {once:true});
        inp.click();
      });
      if(!file) return;
      const text = await file.text();
      const arr = JSON.parse(text);
      if(!Array.isArray(arr)) throw new Error('Некорректный формат');

      // Приводим к [{start}]
      const incoming = [];
      for(const it of arr){
        if(typeof it === 'string'){
          if(validISO(it)) incoming.push({start:it});
        } else if (it && typeof it === 'object'){
          if(typeof it.start === 'string' && validISO(it.start)){
            incoming.push({start:it.start});
          }
        }
      }
      if(!incoming.length) throw new Error('Не найдено корректных дат начала');

      // Объединяем с текущими и чистим дубли
      const merged = [...state.starts, ...incoming];
      const uniq = Array.from(new Set(merged.map(x=>x.start))).map(s=>({start:s}));
      uniq.sort((a,b)=>a.start.localeCompare(b.start));
      state.starts = uniq;
      persist(); renderAll();
    }catch(err){
      alert('Ошибка импорта: '+(err?.message||err));
    }
  });

  // ----- Service worker -----
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', ()=> {
      navigator.serviceWorker.register('./sw.js').catch(()=>{});
    });
  }

  // initial view
  (function initViewToLast(){
    if(state.starts.length){
      const last = state.starts[state.starts.length-1];
      const d = fromISO(last.start);
      state.viewYear = d.getFullYear();
      state.viewMonth = d.getMonth();
    }
  })();
  renderAll();
})();
</script>
</body>
</html>
